<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="SPARK - System, Progress, Action, Results, Knowledge" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#9b0f63" />
  <link rel="icon" type="image/png" href="assets/icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <title>SPARK</title>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap;">
      <img src="UWLogoTP.png" alt="UW Logo" style="height: 60px;" />
      <h1>SPARK</h1>
      <button id="burgerMenuBtn" class="burger-menu" aria-label="Open menu" style="margin-left:auto; font-size:2em; background:none; border:none; cursor:pointer;">&#9776;</button>
    </div>
    <nav>
      <div id="mainNavButtons">
        <button onclick="switchTab('home')">üè† Home</button>
        <button onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button onclick="switchTab('add')">‚ûï Add Contact</button>
        <button onclick="switchTab('view')">üìá View Contacts</button>
        <button onclick="switchTab('log')">üìù Tracker</button>
        <button onclick="switchTab('scripts')">üí¨ Scripts</button>
        <button onclick="switchTab('gamification')">üèÜ Progress</button>
        <button id="settingsBtn" onclick="openSettingsModal()" style="background: #fde7f3; color: #9b0f63; font-weight:600;">‚öôÔ∏è Settings</button>
      </div>
      <div id="mobileNavMenu" class="mobile-nav-menu" style="display:none;"></div>
    </nav>
  </header>

  <!-- Edit Contact Modal -->
  <div id="editContactModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Edit Contact</h3>
      <form id="editContactForm">
        <div class="form-group">
          <label for="editName">Name:</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label for="editEmail">Email:</label>
          <input type="email" id="editEmail">
        </div>
        <div class="form-group">
          <label for="editTelephone">Telephone:</label>
          <input type="tel" id="editTelephone">
        </div>
        <div class="form-group">
          <label for="editCategory">Category:</label>
          <select id="editCategory" required>
            <option value="Friends & Family">Friends & Family</option>
            <option value="Recreation">Recreation</option>
            <option value="Occupation">Occupation</option>
            <option value="Geographic">Geographic</option>
            <option value="Same Name">Same Name</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editNotes">Notes:</label>
          <textarea id="editNotes"></textarea>
        </div>
        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Onboarding Modal -->
  <div id="onboardingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <img src="UWLogoTP.png" alt="UW Logo" style="height: 40px;" />
        <h2>Welcome to SPARK!</h2>
      </div>
      <div class="modal-body">
        <p>Are you a new partner (less than 30 days, <6 customers) or an established partner?</p>
        <div class="partner-type-selection">
          <button id="newPartnerBtn" class="partner-btn"><span class="icon">üßë</span>I'm a new partner</button>
          <button id="establishedPartnerBtn" class="partner-btn"><span class="icon">üßë‚Äçüéì</span>I'm an established partner</button>
        </div>
        
        <!-- New Partner Form -->
        <div id="newPartnerForm" class="partner-form" style="display: none;">
          <label>Join Date: <input type="date" id="joinDate" required /></label>
          <label>Current Customer Count: <input type="number" id="customerCount" min="0" /></label>
          <button type="button" id="startFastStart">Begin Fast Start</button>
        </div>

        <!-- Established Partner Form -->
        <div id="establishedPartnerForm" class="partner-form" style="display: none;">
          <label>Join Date: <input type="date" id="establishedJoinDate" required /></label>
          <label>Current "Stairway to Success" Level:
            <select id="currentLevel" required>
              <option value="">Select your level</option>
              <option value="QD">Qualified Distributor (QD)</option>
              <option value="QDStar">Qualified Distributor ‚≠êÔ∏è (QD Star)</option>
              <option value="SQD">Senior Qualified Distributor (SQD)</option>
              <option value="FTL">Future Team Leader (FTL)</option>
              <option value="TL">Team Leader (TL)</option>
              <option value="STL">Senior Team Leader (STL)</option>
              <option value="GL">Group Leader (GL)</option>
              <option value="SGL">Senior Group Leader (SGL)</option>
              <option value="NGL">National Group Leader (NGL)</option>
              <option value="NNL">National Network Leader (NNL)</option>
            </select>
          </label>
          <label>Current Customer Count: <input type="number" id="establishedCustomerCount" min="0" required /></label>
          <label>Current Partner Count: <input type="number" id="establishedPartnerCount" min="0" required /></label>
          <label>Target Level:
            <select id="targetLevel" required>
              <option value="">Select target level</option>
              <option value="QDStar">Qualified Distributor ‚≠êÔ∏è (QD Star)</option>
              <option value="SQD">Senior Qualified Distributor (SQD)</option>
              <option value="FTL">Future Team Leader (FTL)</option>
              <option value="TL">Team Leader (TL)</option>
              <option value="STL">Senior Team Leader (STL)</option>
              <option value="GL">Group Leader (GL)</option>
              <option value="SGL">Senior Group Leader (SGL)</option>
              <option value="NGL">National Group Leader (NGL)</option>
              <option value="NNL">National Network Leader (NNL)</option>
            </select>
          </label>
          <label>Target Date: <input type="date" id="targetDate" required /></label>
          <button type="button" id="setGoals">Set My Goals</button>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="home" class="tab">
      <!-- Onboarding Video Section -->
      <div class="video-section">
        <h3>üé• Welcome to SPARK - Quick Start Guide</h3>
        <div class="video-container">
          <iframe 
            id="onboardingVideo"
            src="https://adilo.bigcommand.com/watch/j5ttQLTf"
            title="SPARK Onboarding Video"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
Àô      </div>

        <h2>Welcome</h2>
        <p>
          ‚ö° <strong>Welcome to SPARK</strong> - your System for Progress, Action, Results & Knowledge<br />
          Your Smart Team-Builder, Coach & Daily Companion.
        </p>
        <p>
          Whether you're just starting out or building momentum, SPARK is here to guide you every step of the way.<br />
          Track your progress. Get expert scripts. Build belief. Take action ‚Äî daily.
        </p>
        <p>
          üí° <strong>Tip:</strong> Tap 'Get Started' for today's focus, or explore scripts and tools when you need a boost.
        </p>
        <p>
          Let's grow your UW business ‚Äî one conversation at a time. üöÄ
        </p>
        <div class="sticky-bottom-btn">
          <button id="getStartedBtn" class="primary-btn">Get Started</button>
        </div>
      </section>

    <style>
    .sticky-bottom-btn {
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      padding: 1em 0 1.5em 0;
      z-index: 10;
      display: flex;
      justify-content: center;
      box-shadow: 0 -4px 16px rgba(155,15,99,0.04);
    }
    @media (max-width: 600px) {
      .sticky-bottom-btn {
        padding-bottom: 2.5em;
      }
    }
    </style>

    <!-- Daily Focus Modal -->
    <div id="focusModal" class="modal" style="display:none;">
      <div class="modal-content focus-modal-content" style="max-width:400px;">
        <span class="close" id="closeFocusModal">&times;</span>
        <h3>Today's Focus</h3>
        <hr class="modal-divider" />
        <div id="focusContent" class="focus-modal-body" style="margin-top:1em;"></div>
      </div>
    </div>

    <section id="dashboard" class="tab" style="display:none">
      <h2>Dashboard</h2>
      <div id="quoteOfTheDayCard" class="quote-card"></div>
      
      <!-- Gamification Section - Full on desktop, compact on mobile -->
      <div class="gamification-card desktop-only">
        <div style="position: relative; z-index: 1;">
          <div id="levelIndicator" class="level-indicator"></div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
            <div id="streakCounter" class="streak-counter"></div>
            <div style="text-align: right;">
              <div style="font-size: 0.9rem; opacity: 0.9;">Experience Points</div>
              <div id="xpDisplay" style="font-size: 1.5rem; font-weight: 600;">0 XP</div>
            </div>
          </div>
          <div class="xp-bar">
            <div id="xpBar" class="xp-fill" style="width: 0%;"></div>
          </div>
        </div>
      </div>
      
      <!-- Mobile Gamification Summary -->
      <div class="mobile-gamification-summary mobile-only">
        <div class="metric-card">
          <h3>üèÜ Progress Summary</h3>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0;">
            <div id="mobileLevelIndicator" style="font-weight: 600; color: #4B0082;"></div>
            <div id="mobileStreakCounter" class="streak-counter" style="margin: 0;"></div>
          </div>
          <div style="text-align: center; margin: 0.5rem 0;">
            <div style="font-size: 0.9rem; opacity: 0.7;">Experience Points</div>
            <div id="mobileXpDisplay" style="font-size: 1.2rem; font-weight: 600; color: #4CAF50;">0 XP</div>
          </div>
          <div class="xp-bar" style="height: 15px;">
            <div id="mobileXpBar" class="xp-fill" style="width: 0%;"></div>
          </div>
          <div style="text-align: center; margin-top: 0.5rem;">
            <button onclick="switchTab('gamification')" style="background: #9b0f63; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer;">
              View Full Stats üèÜ
            </button>
          </div>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="metric-card">
          <h3>Fast Start Progress</h3>
          <div class="progress-container">
            <div class="progress-item">
              <span>Customers: </span>
              <span id="customerProgress">0/6</span>
              <div class="progress-bar">
                <div id="customerProgressBar" class="progress-fill"></div>
              </div>
            </div>
            <div class="progress-item">
              <span>Partners: </span>
              <span id="partnerProgress">0/1</span>
              <div class="progress-bar">
                <div id="partnerProgressBar" class="progress-fill"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="metric-card">
          <h3>Activity Metrics</h3>
          <div class="metrics-grid">
            <div class="metric">
              <span class="metric-label">Total Contacts</span>
              <span id="totalContacts" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Invitations Sent</span>
              <span id="invitesCount" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Appointments Set</span>
              <span id="appointmentsSetCount" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Appointments Sat</span>
              <span id="appointmentsSatCount" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Customers Signed</span>
              <span id="customersSignedCount" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Partners Signed</span>
              <span id="partnersSignedCount" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Invite to Customer Ratio</span>
              <span id="inviteCustomerRatio" class="metric-value">‚Äî</span>
            </div>
          </div>
        </div>
        <div class="metric-card">
          <h3>Time Tracking</h3>
          <div class="metrics-grid">
            <div class="metric">
              <span class="metric-label">Days in Business</span>
              <span id="dayCount" class="metric-value">0</span>
            </div>
            <div class="metric">
              <span class="metric-label">Days Remaining</span>
              <span id="daysRemaining" class="metric-value">30</span>
            </div>
          </div>
        </div>
        <div class="metric-card" id="aiCoachCardGrid"></div>
      </div>
      
      <!-- Achievements Section - Desktop only -->
      <div class="metric-card desktop-only">
        <h3>üèÜ Achievements</h3>
        <div id="achievementsGrid" class="achievement-grid"></div>
      </div>
      
      <div class="dashboard-accordion">
        <div class="accordion-section">
          <button class="accordion-header" aria-expanded="true">Fast Start Progress</button>
          <div class="accordion-content">
            <div class="metric-card">
              <h3>Fast Start Progress</h3>
              <div class="progress-container">
                <div class="progress-item">
                  <span>Customers: </span>
                  <span id="customerProgressAccordion">0/6</span>
                  <div class="progress-bar">
                    <div id="customerProgressBarAccordion" class="progress-fill"></div>
                  </div>
                </div>
                <div class="progress-item">
                  <span>Partners: </span>
                  <span id="partnerProgressAccordion">0/1</span>
                  <div class="progress-bar">
                    <div id="partnerProgressBarAccordion" class="progress-fill"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-section">
          <button class="accordion-header" aria-expanded="false">Activity Metrics</button>
          <div class="accordion-content" style="display:none;">
            <div class="metric-card">
              <h3>Activity Metrics</h3>
              <div class="metrics-grid">
                <div class="metric">
                  <span class="metric-label">Total Contacts</span>
                  <span id="totalContactsAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Invitations Sent</span>
                  <span id="invitesCountAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Appointments Set</span>
                  <span id="appointmentsSetCountAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Appointments Sat</span>
                  <span id="appointmentsSatCountAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Customers Signed</span>
                  <span id="customersSignedCountAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Partners Signed</span>
                  <span id="partnersSignedCountAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Invite to Customer Ratio</span>
                  <span id="inviteCustomerRatioAccordion" class="metric-value">‚Äî</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-section">
          <button class="accordion-header" aria-expanded="false">Time Tracking</button>
          <div class="accordion-content" style="display:none;">
            <div class="metric-card">
              <h3>Time Tracking</h3>
              <div class="metrics-grid">
                <div class="metric">
                  <span class="metric-label">Days in Business</span>
                  <span id="dayCountAccordion" class="metric-value">0</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Days Remaining</span>
                  <span id="daysRemainingAccordion" class="metric-value">30</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-section">
          <button class="accordion-header" aria-expanded="false">UW AI Coach</button>
          <div class="accordion-content" style="display:none;">
            <div id="aiCoachCardAccordion"></div>
          </div>
        </div>
      </div>
      <div id="motivationalMessage" class="motivational-message"></div>
    </section>

    <!-- Gamification Tab -->
    <section id="gamification" class="tab" style="display:none">
      <h2>üèÜ Progress</h2>
      
      <!-- Full Gamification Card -->
      <div class="gamification-card">
        <div style="position: relative; z-index: 1;">
          <div id="gamificationLevelIndicator" class="level-indicator"></div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
            <div id="gamificationStreakCounter" class="streak-counter"></div>
            <div style="text-align: right;">
              <div style="font-size: 0.9rem; opacity: 0.9;">Experience Points</div>
              <div id="gamificationXpDisplay" style="font-size: 1.5rem; font-weight: 600;">0 XP</div>
            </div>
          </div>
          <div class="xp-bar">
            <div id="gamificationXpBar" class="xp-fill" style="width: 0%;"></div>
          </div>
        </div>
      </div>
      
      <!-- Achievements Section -->
      <div class="metric-card">
        <h3>üèÜ Achievements</h3>
        <div id="gamificationAchievementsGrid" class="achievement-grid"></div>
      </div>
      
      <!-- Level Progression -->
      <div class="metric-card">
        <h3>üìà Level Progression</h3>
        <div id="levelProgressionGrid"></div>
      </div>
      
      <!-- Recent Activity -->
      <div class="metric-card">
        <h3>üìä Recent Activity</h3>
        <div id="recentActivityLog"></div>
      </div>
    </section>

    <section id="add" class="tab add-scroll-section" style="display:none; position:relative; min-height:80vh;">
      <!-- AI Coach Pop-up for Add Contacts (hidden by default) -->
      <div id="aiCoachAddModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; border-radius:10px; box-shadow:0 6px 32px rgba(155,15,99,0.18); z-index:10001; padding:28px 24px; max-width:340px; width:90%; text-align:center; border:2px solid #9b0f63;">
        <div style="font-size:1.5em; margin-bottom:10px;">ü§ñ</div>
        <div style="color:#4B0082; font-weight:600; margin-bottom:10px;">AI Coach Tip</div>
        <div style="color:#333; font-size:1.08em; margin-bottom:18px;">Welcome to the Add Contacts page!<br><br>Here you can add new contacts one by one, or import a list from your phone or computer. <b>The more contacts you add, the more people you can help!</b><br><br>Start by adding a few names, or try the import feature for a quick start.<br><br><span style='color:#4B0082; font-weight:600;'>Tip:</span> Use the <b>FROGS</b> method (Friends, Recreation, Occupation, Geographic, Same Name) to help you think of more people to add!</div>
        <button id="closeAiCoachAddModal" style="background:#9b0f63; color:#fff; border:none; border-radius:5px; padding:8px 18px; font-size:1em; cursor:pointer;">Got it!</button>
      </div>
      <!-- AI Coach Static Banner for Add Contacts (hidden by default) -->
      <div id="aiCoachAddBanner" style="display:none; background: #f3e8fd; color: #4B0082; border-left: 6px solid #9b0f63; border-radius: 6px; padding: 12px 18px; margin-bottom: 16px; font-size: 1.05em; font-weight: 500; box-shadow: 0 2px 8px rgba(155,15,99,0.08);">
        <span style="font-size:1.3em; margin-right:8px;">ü§ñ</span>
        <strong>AI Coach Tip:</strong> Add new contacts one by one, or import a list for a quick start. The more contacts you add, the more people you can help! <span style='color:#4B0082; font-weight:600;'>Tip:</span> Use the <b>FROGS</b> method (Friends, Recreation, Occupation, Geographic, Same Name) to help you think of more people to add!
      </div>

      <h2>Add Contact</h2>
      <div id="contactForm" class="form-container">
        <h3>Add New Contact</h3>
        <form id="addContactForm">
          <div class="form-group">
            <label for="name">Name:</label>
            <input type="text" id="name" required>
          </div>
          <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email">
          </div>
          <div class="form-group">
            <label for="telephone">Telephone:</label>
            <input type="tel" id="telephone">
          </div>
          <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" required>
              <option value="Friends & Family">Friends & Family</option>
              <option value="Recreation">Recreation</option>
              <option value="Occupation">Occupation</option>
              <option value="Geographic">Geographic</option>
              <option value="Same Name">Same Name</option>
            </select>
          </div>
          <div class="form-group">
            <label for="notes">Notes:</label>
            <textarea id="notes"></textarea>
          </div>
          <button type="submit">Add Contact</button>
        </form>
      </div>

      <hr />
      <h3>üì• Import Contacts</h3>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h4 style="margin-top: 0; color: #4B0082;">Choose Import Method:</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="button" onclick="document.getElementById('csvFileInput').click()" style="background: #4CAF50; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
            üìÑ Import CSV File
          </button>
          <button type="button" onclick="document.getElementById('vcfFileInput').click()" style="background: #2196F3; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
            üì± Import vCard (.vcf)
          </button>
        </div>
        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
          <strong>CSV:</strong> Spreadsheet format with columns for Name, Email, Phone, etc.<br>
          <strong>vCard:</strong> Export contacts from your phone's address book
        </p>
        
        <!-- vCard Instructions Section -->
        <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">
          <h5 style="margin: 0 0 10px 0; color: #4B0082; font-size: 1em;">üìã Need help exporting vCard from your phone?</h5>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button type="button" onclick="toggleInstructions('android')" id="androidBtn" style="background: #9b0f63; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
              ü§ñ Android Instructions
            </button>
            <button type="button" onclick="toggleInstructions('ios')" id="iosBtn" style="background: #9b0f63; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
              üçé iOS Instructions
            </button>
          </div>
          
          <!-- Android Instructions -->
          <div id="androidInstructions" style="display: none; margin-top: 12px; background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #4CAF50;">
            <h6 style="margin: 0 0 8px 0; color: #4CAF50;">ü§ñ Android - Google Contacts Method:</h6>
            <ol style="margin: 0; padding-left: 20px; font-size: 0.9em; line-height: 1.4;">
              <li>Open <strong>Google Contacts</strong> app or go to contacts.google.com</li>
              <li>Select contacts you want to export (tap and hold)</li>
              <li>Tap <strong>three dots menu</strong> (‚ãÆ) ‚Üí "Export"</li>
              <li>Choose <strong>"vCard format"</strong> (.vcf)</li>
              <li>Save to Downloads or email to yourself</li>
            </ol>
            <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #666;">
              <strong>Alternative:</strong> Samsung users can use Samsung Contacts app ‚Üí Menu ‚Üí Import/Export ‚Üí Export vCard
            </p>
          </div>
          
          <!-- iOS Instructions -->
          <div id="iosInstructions" style="display: none; margin-top: 12px; background: white; padding: 12px; border-radius: 6px; border-left: 4px solid #007AFF;">
            <h6 style="margin: 0 0 8px 0; color: #007AFF;">üçé iOS - iCloud Method:</h6>
            <ol style="margin: 0; padding-left: 20px; font-size: 0.9em; line-height: 1.4;">
              <li>Go to <strong>icloud.com</strong> on computer</li>
              <li>Sign in with your <strong>Apple ID</strong></li>
              <li>Click <strong>"Contacts"</strong></li>
              <li>Select contacts (Ctrl/Cmd+A for all)</li>
              <li>Click <strong>gear icon</strong> (‚öôÔ∏è) ‚Üí "Export vCard"</li>
              <li>Download the .vcf file</li>
            </ol>
            <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #666;">
              <strong>Alternative:</strong> Use <a href="https://apps.apple.com/gb/app/export-contact/id1342636975" target="_blank" style="color: #007AFF; text-decoration: none;">"Export Contact"</a> app from App Store (optional lifetime purchase of ¬£6.99)
            </p>
          </div>
        </div>
      </div>
      <!-- Fixed scroll prompt for mobile -->
      <div class="scroll-indicator" id="addScrollIndicator" style="display:none;">
        <span>&#8595;</span>
      </div>
      <style>
      @media (max-width: 600px) {
        #add.add-scroll-section {
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
        }
        .scroll-indicator {
          position: fixed;
          right: 18px;
          bottom: 60px;
          z-index: 1000;
          text-align: right;
          font-size: 2em;
          color: #9b0f63;
          animation: bounce 1.5s infinite;
          margin-top: -10px;
          pointer-events: none;
          background: none;
          box-shadow: none;
        }
      }
      @keyframes bounce {
        0%, 100% { transform: translateY(0);}
        50% { transform: translateY(8px);}
      }
      </style>
      <script>
      // Always show scroll indicator on mobile, hide when scrolled to bottom
      document.addEventListener('DOMContentLoaded', function() {
        var addSection = document.getElementById('add');
        var scrollIndicator = document.getElementById('addScrollIndicator');
        function checkAddScroll() {
          if (addSection && scrollIndicator) {
            // Only show on mobile
            if (window.innerWidth <= 600) {
              // Show by default
              scrollIndicator.style.display = 'block';
              // Hide if scrolled to bottom
              addSection.onscroll = function() {
                if (addSection.scrollTop + addSection.clientHeight >= addSection.scrollHeight - 10) {
                  scrollIndicator.style.display = 'none';
                } else {
                  scrollIndicator.style.display = 'block';
                }
              };
              // Also re-check after content changes (e.g., after importing vCard)
              const observer = new MutationObserver(function() {
                // Timeout to allow DOM to update
                setTimeout(function() {
                  if (addSection.scrollTop + addSection.clientHeight >= addSection.scrollHeight - 10) {
                    scrollIndicator.style.display = 'none';
                  } else {
                    scrollIndicator.style.display = 'block';
                  }
                }, 200);
              });
              observer.observe(addSection, { childList: true, subtree: true });
            } else {
              scrollIndicator.style.display = 'none';
            }
          }
        }
        checkAddScroll();
        window.addEventListener('resize', checkAddScroll);
      });
      </script>
      
      <input type="file" accept=".csv" id="csvFileInput" style="display: none;" />
      <input type="file" accept=".vcf,.vcard" id="vcfFileInput" style="display: none;" />
      <div id="importPreview"></div>
      <script>
        document.getElementById('csvFileInput').addEventListener('change', function () {
          if (this.files.length > 0) {
            handleCSVUpload(this.files[0], 'importPreview');
          }
        });
        
        document.getElementById('vcfFileInput').addEventListener('change', function () {
          if (this.files.length > 0) {
            handleVCFUpload(this.files[0], 'importPreview');
          }
        });
      </script>
    </section>

    <section id="view" class="tab" style="display:none">
      <h2>Contact List</h2>
      <div id="contactsList"></div>
    </section>

    <section id="log" class="tab" style="display:none">
      <h2>Activity Tracker</h2>
      <!-- AI Coach Static Banner (hidden by default) -->
      <div id="aiCoachBanner" style="display:none; background: #f3e8fd; color: #4B0082; border-left: 6px solid #9b0f63; border-radius: 6px; padding: 12px 18px; margin-bottom: 16px; font-size: 1.05em; font-weight: 500; box-shadow: 0 2px 8px rgba(155,15,99,0.08);">
        <span style="font-size:1.3em; margin-right:8px;">ü§ñ</span>
        <strong>AI Coach Tip:</strong> When reaching out, a <b>phone call</b> is best! Your passion comes through in your voice, making it easier to arrange appointments. If you can‚Äôt call, try a video or voice message before texting or messaging. <b>Your voice is your superpower!</b>
      </div>
      <!-- AI Coach Pop-up (hidden by default) -->
      <div id="aiCoachPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; border-radius:10px; box-shadow:0 6px 32px rgba(155,15,99,0.18); z-index:10001; padding:28px 24px; max-width:340px; width:90%; text-align:center; border:2px solid #9b0f63;">
        <div style="font-size:1.5em; margin-bottom:10px;">ü§ñ</div>
        <div style="color:#4B0082; font-weight:600; margin-bottom:10px;">AI Coach Tip</div>
        <div style="color:#333; font-size:1.08em; margin-bottom:18px;">When reaching out, a <b>phone call</b> is best! Your passion comes through in your voice, making it easier to arrange appointments. If you can‚Äôt call, <b>try a video or voice message before texting or messaging</b>. <b>Your voice is your superpower!</b></div>
        <button id="closeAiCoachPopup" style="background:#9b0f63; color:#fff; border:none; border-radius:5px; padding:8px 18px; font-size:1em; cursor:pointer;">Got it!</button>
      </div>
      <form id="activityForm">
        <input type="hidden" id="activityContact" />
        <label for="activityType">Action Type:</label>
        <select id="activityType" required>
          <option value="">Select Activity</option>
          <option value="Invite">Send Invitation</option>
          <option value="AppointmentSet">Appointment Set</option>
          <option value="AppointmentSat">Appointment Sat</option>
          <option value="CustomerSigned">Customer Signed</option>
          <option value="PartnerSigned">Partner Signed</option>
        </select><br />
        <label for="activityNote">Notes (optional):</label><br />
        <textarea id="activityNote" rows="3" placeholder="Any notes or context..."></textarea><br />
        <button type="submit">Log Action</button>
        <button type="button" id="suggestAIMessage">üí° Suggest Message</button>
      </form>

      <div id="aiMessageBox" style="margin-top:1em; display:none;">
        <strong>Suggested Message:</strong>
        <div id="aiMessageContent" style="white-space:pre-wrap; background:#f5f5f5; padding:10px; border-radius:6px; margin-top:5px;"></div>
        <button id="copyAIMessageBtn" style="margin-top:8px; display:block;">Copy</button>
      </div>

      <hr />
      <div id="activityLog"></div>
    </section>

    <section id="scripts" class="tab" style="display:none">
      <h2>üí¨ Script Library</h2>
      <p>Browse proven scripts by category. Click any script to copy it to your clipboard.</p>
      
      <div class="scripts-container">
        <div class="script-category">
          <h3>üéØ Invitation Scripts</h3>
          <div class="script-subcategory">
            <h4>New Partners</h4>
            <div id="newInviteScripts" class="script-list"></div>
          </div>
          <div class="script-subcategory">
            <h4>Experienced Partners</h4>
            <div id="experiencedInviteScripts" class="script-list"></div>
          </div>
        </div>

        <div class="script-category">
          <h3>üìû Follow-up Scripts</h3>
          <div class="script-subcategory">
            <h4>New Partners</h4>
            <div id="newFollowUpScripts" class="script-list"></div>
          </div>
          <div class="script-subcategory">
            <h4>Experienced Partners</h4>
            <div id="experiencedFollowUpScripts" class="script-list"></div>
          </div>
        </div>

        <div class="script-category">
          <h3>üõ°Ô∏è Objection Handlers</h3>
          <div id="objectionScripts" class="script-list"></div>
        </div>

        <div class="script-category">
          <h3>‚ö° Urgency Scripts</h3>
          <div class="script-subcategory">
            <h4>New Partners</h4>
            <div id="newUrgencyScripts" class="script-list"></div>
          </div>
          <div class="script-subcategory">
            <h4>Experienced Partners</h4>
            <div id="experiencedUrgencyScripts" class="script-list"></div>
          </div>
        </div>

        <div class="script-category">
          <h3>ü§ù Referral Scripts</h3>
          <div class="script-subcategory">
            <h4>New Partners</h4>
            <div id="newReferralScripts" class="script-list"></div>
          </div>
          <div class="script-subcategory">
            <h4>Experienced Partners</h4>
            <div id="experiencedReferralScripts" class="script-list"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Settings/Danger Zone Modal -->
  <div id="settingsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:10000;">
    <div class="modal-content" style="max-width:400px; background: #fde7f3; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-height:90vh; overflow-y:auto; border-radius:8px; padding:20px;">
      <span class="close" id="closeSettingsModal">&times;</span>
      <h3 style="color:#ff4444;">Danger Zone</h3>
      <p style="color:#b71c1c; font-weight:600;">Proceed with caution! These actions affect all your app data.</p>
      <button id="exportDataBtn" style="background:#4CAF50; color:white; width:100%; margin-bottom:10px;">‚¨áÔ∏è Export My Data</button>
      <button id="importDataBtn" style="background:#2196F3; color:white; width:100%; margin-bottom:10px;">‚¨ÜÔ∏è Import My Data</button>
      <input type="file" id="importDataFile" accept="application/json" style="display:none;" />
      <button onclick="resetApp()" style="background: #ff4444; color: white; width:100%;">üîÑ Reset App</button>
      <div style="margin-top:18px; font-size:0.95em; color:#555;">
        <b>Export</b>: Download a backup of all your contacts, actions, and progress.<br>
        <b>Import</b>: Restore your data from a backup file.<br>
        <b>Reset</b>: Permanently erase all your app data.
      </div>
    </div>
  </div>

  <!-- Survey Popup Modal -->
  <div id="surveyPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:10001;">
    <div class="modal-content" style="max-width:450px; background: white; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; border-radius:12px; padding:25px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
      <div style="font-size:3em; margin-bottom:15px;">üöÄ</div>
      <h3 style="color:#4B0082; margin:0 0 15px 0; font-size:1.4em;">Help Shape SPARK's Future!</h3>
      <p style="color:#555; line-height:1.5; margin-bottom:20px; font-size:1.05em;">
        You've been using SPARK for a while now. We'd love your feedback to make it even better and help us pitch to UW!
      </p>
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
        <p style="margin:0; color:#666; font-size:0.95em;">
          <strong>üìä 2-minute survey</strong><br>
          <strong>üéÅ Complete for 50 XP bonus!</strong><br>
          <strong>üí° Your feedback could launch SPARK officially</strong>
        </p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
        <button onclick="openSurvey()" style="background:#4CAF50; color:white; border:none; padding:12px 20px; border-radius:6px; font-size:1em; cursor:pointer; font-weight:600;">
          Take Survey Now
        </button>
        <button onclick="dismissSurvey('later')" style="background:#9b0f63; color:white; border:none; padding:12px 20px; border-radius:6px; font-size:1em; cursor:pointer;">
          Remind Me Later
        </button>
        <button onclick="dismissSurvey('never')" style="background:none; color:#666; border:1px solid #ddd; padding:12px 20px; border-radius:6px; font-size:1em; cursor:pointer;">
          Not Now
        </button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script src="import.js"></script>
  <script src="onboarding.js"></script>
  <script src="ai.js"></script>
  <script src="data.js"></script>
  <script src="scripts.js"></script>
  <script src="scripts-ui.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Always start on Home tab for new and returning users
      switchTab('home');
      // Force Home tab after a short delay in case other scripts override
      setTimeout(() => {
        switchTab('home');
      }, 200);
      
      // AI Coach Banner/Popup Logic for Tracker Page
      const activityType = document.getElementById('activityType');
      const aiCoachPopup = document.getElementById('aiCoachPopup');
      const aiCoachBanner = document.getElementById('aiCoachBanner');
      const closeAiCoachPopup = document.getElementById('closeAiCoachPopup');
      let aiCoachPopupShown = localStorage.getItem('aiCoachPopupShown') === 'true';

      if (activityType) {
        activityType.addEventListener('change', function() {
          if (this.value === 'Invite') {
            if (!aiCoachPopupShown) {
              aiCoachPopup.style.display = 'block';
              aiCoachPopupShown = true;
              localStorage.setItem('aiCoachPopupShown', 'true');
            } else {
              aiCoachBanner.style.display = 'block';
            }
          } else {
            aiCoachBanner.style.display = 'none';
          }
        });
        
        // Check if activity type is pre-selected to 'Invite' (from trackActivityForContact)
        setTimeout(() => {
          if (activityType.value === 'Invite') {
            if (!aiCoachPopupShown) {
              aiCoachPopup.style.display = 'block';
              aiCoachPopupShown = true;
              localStorage.setItem('aiCoachPopupShown', 'true');
            } else {
              aiCoachBanner.style.display = 'block';
            }
          }
        }, 300); // Increased delay to ensure the value is set
        
        // More robust check - also look for stored contact name and check multiple times
        const checkForPreSelectedInvite = () => {
          if (activityType.value === 'Invite' || localStorage.getItem('activityContact')) {
            if (!aiCoachPopupShown) {
              aiCoachPopup.style.display = 'block';
              aiCoachPopupShown = true;
              localStorage.setItem('aiCoachPopupShown', 'true');
            } else {
              aiCoachBanner.style.display = 'block';
            }
            return true; // Found it, stop checking
          }
          return false; // Keep checking
        };
        
        // Check multiple times with increasing delays
        let checkCount = 0;
        const maxChecks = 5;
        const checkInterval = setInterval(() => {
          checkCount++;
          if (checkForPreSelectedInvite() || checkCount >= maxChecks) {
            clearInterval(checkInterval);
          }
        }, 200); // Increased interval for more reliable detection
      }
      if (closeAiCoachPopup) {
        closeAiCoachPopup.addEventListener('click', function() {
          aiCoachPopup.style.display = 'none';
          aiCoachBanner.style.display = 'block';
        });
      }

      // Settings Modal Logic
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const closeSettingsModal = document.getElementById('closeSettingsModal');
      const exportDataBtn = document.getElementById('exportDataBtn');
      const importDataBtn = document.getElementById('importDataBtn');
      const importDataFile = document.getElementById('importDataFile');

      if (settingsBtn && settingsModal && closeSettingsModal) {
        settingsBtn.addEventListener('click', function(e) {
          e.preventDefault();
          settingsModal.style.display = 'block';
        });
        closeSettingsModal.addEventListener('click', function() {
          settingsModal.style.display = 'none';
        });
        window.addEventListener('click', function(event) {
          if (event.target === settingsModal) {
            settingsModal.style.display = 'none';
          }
        });
      }

      // Export Data Logic
      if (exportDataBtn) {
        exportDataBtn.addEventListener('click', function() {
          const data = {
            contacts: JSON.parse(localStorage.getItem('contacts') || '[]'),
            metrics: JSON.parse(localStorage.getItem('metrics') || '{}'),
            gamification: JSON.parse(localStorage.getItem('gamification') || '{}'),
            activityLog: JSON.parse(localStorage.getItem('activityLog') || '[]'),
            activities: JSON.parse(localStorage.getItem('activities') || '[]'),
            joinDate: localStorage.getItem('joinDate') || '',
            onboardingComplete: localStorage.getItem('onboardingComplete') || ''
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'spark-backup.json';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);
        });
      }

      // Import Data Logic
      if (importDataBtn && importDataFile) {
        importDataBtn.addEventListener('click', function() {
          importDataFile.value = '';
          importDataFile.click();
        });
        importDataFile.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (!file) return;
          if (!file.name.endsWith('.json')) {
            alert('Please select a valid JSON backup file.');
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const data = JSON.parse(e.target.result);
              if (!data.contacts || !data.metrics || !data.gamification) {
                alert('Invalid backup file.');
                return;
              }
              if (confirm('Importing will overwrite your current data. Continue?')) {
                localStorage.setItem('contacts', JSON.stringify(data.contacts));
                localStorage.setItem('metrics', JSON.stringify(data.metrics));
                localStorage.setItem('gamification', JSON.stringify(data.gamification));
                localStorage.setItem('activityLog', JSON.stringify(data.activityLog || []));
                localStorage.setItem('activities', JSON.stringify(data.activities || []));
                if (data.joinDate) localStorage.setItem('joinDate', data.joinDate);
                if (data.onboardingComplete) localStorage.setItem('onboardingComplete', data.onboardingComplete);
                alert('Data imported successfully! The app will now reload.');
                window.location.reload();
              }
            } catch (err) {
              alert('Failed to import data: ' + err.message);
            }
          };
          reader.readAsText(file);
        });
      }
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js').then(function (registration) {
          console.log('ServiceWorker registered with scope:', registration.scope);

          // --- Update detection logic ---
          registration.onupdatefound = function () {
            const newWorker = registration.installing;
            newWorker.onstatechange = function () {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdatePrompt(() => {
                  newWorker.postMessage('SKIP_WAITING');
                });
              }
            };
          };
        }, function (err) {
          console.log('ServiceWorker registration failed:', err);
        });
      });

      // Listen for the controlling service worker changing and reload the page
      navigator.serviceWorker.addEventListener('controllerchange', function () {
        window.location.reload();
      });
    }

    // Show a prompt to the user when an update is available
    function showUpdatePrompt(onAccept) {
      // You can replace this with a custom modal or toast if desired
      if (confirm('A new version of SPARK is available! Click OK to update now.')) {
        onAccept();
      }
    }

    // Settings Modal Function
    function openSettingsModal() {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal) {
        settingsModal.style.display = 'block';
      }
    }

    // Toggle Instructions Function
    function toggleInstructions(platform) {
      const androidInstructions = document.getElementById('androidInstructions');
      const iosInstructions = document.getElementById('iosInstructions');
      const androidBtn = document.getElementById('androidBtn');
      const iosBtn = document.getElementById('iosBtn');
      
      // Hide both instructions first
      androidInstructions.style.display = 'none';
      iosInstructions.style.display = 'none';
      
      // Reset button styles
      androidBtn.style.background = '#9b0f63';
      iosBtn.style.background = '#9b0f63';
      
      // Show selected instructions and highlight button
      if (platform === 'android') {
        androidInstructions.style.display = 'block';
        androidBtn.style.background = '#4CAF50';
      } else if (platform === 'ios') {
        iosInstructions.style.display = 'block';
        iosBtn.style.background = '#007AFF';
      }
    }

    // Survey System Functions
    function checkSurveyEligibility() {
      // Don't show if already completed or recently dismissed
      if (localStorage.getItem('surveyCompleted') || localStorage.getItem('surveyDismissed')) {
        return false;
      }
      
      // Check session count
      const sessionCount = parseInt(localStorage.getItem('sessionCount') || '0');
      if (sessionCount < 3) return false;
      
      // Check engagement metrics
      const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
      const activities = JSON.parse(localStorage.getItem('activities') || '[]');
      const gamification = JSON.parse(localStorage.getItem('gamification') || '{}');
      
      // Must have some engagement
      if (contacts.length === 0 && activities.length === 0) return false;
      
      // Must have reached at least Level 2 or logged some activities
      const userLevel = gamification.level || 1;
      if (userLevel < 2 && activities.length < 3) return false;
      
      return true;
    }
    
    function showSurveyPopup() {
      if (checkSurveyEligibility()) {
        const surveyPopup = document.getElementById('surveyPopup');
        surveyPopup.style.display = 'block';
      }
    }
    
    function openSurvey() {
      // Replace with your actual Google Form URL
      const surveyUrl = 'https://forms.gle/EEAGxn5f4C5JzMqS8';
      window.open(surveyUrl, '_blank');
      
      // Mark as completed and give XP bonus
      localStorage.setItem('surveyCompleted', 'true');
      localStorage.setItem('surveyCompletedDate', new Date().toISOString());
      
      // Add XP bonus
      if (window.addXP) {
        addXP(50, 'Survey Completion');
      }
      
      // Hide popup
      document.getElementById('surveyPopup').style.display = 'none';
      
      // Show success message
      showToast('Thank you! 50 XP bonus added for completing the survey! üéâ');
    }
    
    function dismissSurvey(action) {
      const surveyPopup = document.getElementById('surveyPopup');
      surveyPopup.style.display = 'none';
      
      if (action === 'later') {
        // Remind in 3 days
        const remindDate = new Date();
        remindDate.setDate(remindDate.getDate() + 3);
        localStorage.setItem('surveyDismissed', remindDate.toISOString());
        showToast('We\'ll remind you in 3 days! üìÖ');
      } else if (action === 'never') {
        // Don't show again for 30 days
        const remindDate = new Date();
        remindDate.setDate(remindDate.getDate() + 30);
        localStorage.setItem('surveyDismissed', remindDate.toISOString());
        showToast('No problem! We won\'t ask again for a while.');
      }
    }
    
    // Track sessions and check for survey eligibility
    function trackSession() {
      const sessionCount = parseInt(localStorage.getItem('sessionCount') || '0');
      const lastSession = localStorage.getItem('lastSessionDate');
      const today = new Date().toDateString();
      
      // Only increment if it's a new day
      if (lastSession !== today) {
        localStorage.setItem('sessionCount', sessionCount + 1);
        localStorage.setItem('lastSessionDate', today);
        
        // Check if we should show survey after 3+ sessions
        if (sessionCount + 1 >= 3) {
          // Delay to ensure user is engaged
          setTimeout(() => {
            showSurveyPopup();
          }, 5000); // 5 second delay
        }
      }
    }
    
    // Initialize survey system
    document.addEventListener('DOMContentLoaded', function() {
      // Track this session
      trackSession();
      
      // Check for survey eligibility on page load (with delay)
      setTimeout(() => {
        showSurveyPopup();
      }, 3000); // 3 second delay
    });
  </script>
  <script>
    // AI Coach Add Contacts Modal/Banner Logic
    document.addEventListener('DOMContentLoaded', function() {
      var addTab = document.getElementById('add');
      var aiCoachAddModal = document.getElementById('aiCoachAddModal');
      var aiCoachAddBanner = document.getElementById('aiCoachAddBanner');
      var closeAiCoachAddModal = document.getElementById('closeAiCoachAddModal');
      // Only show modal once per user
      function showAddCoachModalIfNeeded() {
        if (!localStorage.getItem('aiCoachAddModalShown')) {
          aiCoachAddModal.style.display = 'block';
        } else {
          aiCoachAddBanner.style.display = 'block';
        }
      }
      // Listen for Add tab activation
      var origSwitchTab = window.switchTab;
      window.switchTab = function(tabId) {
        origSwitchTab(tabId);
        if (tabId === 'add') {
          setTimeout(showAddCoachModalIfNeeded, 200);
        }
      };
      // Close modal, show banner, set localStorage
      if (closeAiCoachAddModal) {
        closeAiCoachAddModal.addEventListener('click', function() {
          aiCoachAddModal.style.display = 'none';
          aiCoachAddBanner.style.display = 'block';
          localStorage.setItem('aiCoachAddModalShown', 'true');
        });
      }
    });
  </script>
</body>
</html>
